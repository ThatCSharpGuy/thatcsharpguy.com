<!DOCTYPE html>
<html lang="es"  itemscope itemtype="http://schema.org/Blog">
<head>
        <!–– Made with Lockdown: https://github.com/fferegrino/lockdown ––>
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c"></meta>

  <link rel="shortcut icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <script src="/js/main.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/vs.min.css" integrity="sha512-aWjgJTbdG4imzxTxistV5TVNffcYGtIQQm2NBNahV6LmX14Xq9WwZTL1wPjaSglUuVzYgwrq+0EuI4+vKvQHHw==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js" integrity="sha512-9GIHU4rPKUMvNOHFOer5Zm2zHnZOjayOO3lZpokhhCtgt8FNlNiW/bb7kl0R5ZXfCDVPcQ8S4oBdNs92p5Nm2w==" crossorigin="anonymous"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script data-ad-client="ca-pub-9566151416325480" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#2176ff">
<meta name="msapplication-TileColor" content="#eeeef2">
<meta name="theme-color" content="#eeeef2">


<title>Árboles de expresiones en C# | That C# guy</title>

<!-- Search Engine -->
<meta name="description" content="Un árbol de expresiones permite examinar el código de un delegado en tiempo de ejecución, permitiéndote así aprovechar al máximo los recursos de tu sistema.">
<meta name="image" content="">
<!-- Schema.org for Google -->
<meta itemprop="name" content="Árboles de expresiones en C#">
<meta itemprop="description" content="Un árbol de expresiones permite examinar el código de un delegado en tiempo de ejecución, permitiéndote así aprovechar al máximo los recursos de tu sistema.">
<meta itemprop="image" content="">
<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Árboles de expresiones en C#">
<meta name="twitter:description" content="Un árbol de expresiones permite examinar el código de un delegado en tiempo de ejecución, permitiéndote así aprovechar al máximo los recursos de tu sistema.">
<meta name="twitter:site" content="@io_exception">
<meta name="twitter:creator" content="@io_exception">
<meta name="twitter:image" content="">
<!-- Open Graph general (Facebook, Pinterest & Google+) -->
<meta name="og:title" content="Árboles de expresiones en C#">
<meta name="og:description" content="Un árbol de expresiones permite examinar el código de un delegado en tiempo de ejecución, permitiéndote así aprovechar al máximo los recursos de tu sistema.">
<meta name="og:image" content="">
<meta name="og:url" content="https://thatcsharpguy.com/">
<meta name="og:site_name" content="That C# guy">
<meta name="og:locale" content="es">
<meta name="og:type" content="website">


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GPXCSH21CP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GPXCSH21CP');
</script>

        
</head>

<body style="position: relative; min-height: 100%; top: 0px;">  
        <header class="site-header " role="banner">
  <div class="wrapper">
     <div class="site-header-inner">
       <span class="site-brand">
         <a class="site-brand-inner" rel="author" href="/">
          <!-- <img class="site-favicon" title="Your awesome title" src="" onerror="this.style.display='none'"> -->
          That C# guy
        </a>
      </span>
        <nav class="site-nav">
           <input type="checkbox" id="nav-trigger" class="nav-trigger">
           <label for="nav-trigger">
              <span class="menu-icon">
                 <svg viewbox="0 0 18 15" width="18px" height="15px">
                    <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
                 </svg>
              </span>
           </label>
           <div class="trigger">
             <!-- Header links -->
              <a class="page-link" target="_blank" href="https://www.youtube.com/thatcsharpguy/">YOUTUBE</a>
              <span class="page-link">
    <div id="google_translate_element" style="display: none;"></div>
    <span class="ct-language">
       <ul class="list-unstyled ct-language-dropdown">
         <li>
            <a href="#" class="lang-select" data-lang="es">
            <img src="https://www.countryflags.io/mx/flat/64.png" title="México">
            </a>
         </li>
          <li>
             <a href="#" class="lang-select" data-lang="en">
             <img src="https://www.countryflags.io/gb/flat/64.png" title="English">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="fr">
             <img src="https://www.countryflags.io/fr/flat/64.png" title="Franch">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="zh-CN">
             <img src="https://www.countryflags.io/cn/flat/64.png" title="Chinese(Simple)">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ja">
             <img src="https://www.countryflags.io/jp/flat/64.png" title="Japan">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ko">
             <img src="https://www.countryflags.io/kr/flat/64.png" title="Korean">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ru">
             <img src="https://www.countryflags.io/ru/flat/64.png" title="Russia">
             </a>
          </li>
       </ul>
    </span>
    <script type="text/javascript">
       function googleTranslateElementInit() {
         new google.translate.TranslateElement({
           pageLanguage: '',
           autoDisplay: false,
           layout: google.translate.TranslateElement.InlineLayout.VERTICAL
         }, 'google_translate_element');
       
         function restoreLang() {
           var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
           if (!iframe) return;
       
           var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
           var restore_el = innerDoc.getElementsByTagName("button");
       
           for (var i = 0; i < restore_el.length; i++) {
             if (restore_el[i].id.indexOf("restore") >= 0) {
               restore_el[i].click();
               var close_el = innerDoc.getElementsByClassName("goog-close-link");
               close_el[0].click();
               return;
             }
           }
         }
       
         function triggerHtmlEvent(element, eventName) {
           var event;
           if (document.createEvent) {
             event = document.createEvent('HTMLEvents');
             event.initEvent(eventName, true, true);
             element.dispatchEvent(event);
           } else {
             event = document.createEventObject();
             event.eventType = eventName;
             element.fireEvent('on' + event.eventType, event);
           }
         }
       
         var googleCombo = document.querySelector("select.goog-te-combo");
         var langSelect = document.querySelector('.ct-language');
         langSelect.addEventListener('click', function(event) {
           if (!event.target) {
             return;
           }
       
           var selected = document.querySelector('.ct-language .ct-language-selected');
           if (selected) {
             selected.classList.remove('ct-language-selected');
           }
       
           var target = event.target;
           while (target && target !== langSelect ) {
             if (target.matches('.lang-select')) {
               break;
             }
             target = target.parentElement;
           }
       
           if (target && target.matches('.lang-select')) {
             var lang = target.getAttribute('data-lang');
             if (lang == "es") {
               restoreLang();
             } else {
               target.parentElement.classList.add('ct-language-selected');
               googleCombo.value = lang;
               triggerHtmlEvent(googleCombo, 'change');
             }
           }
       
           event.preventDefault();
         });
       }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
 </span>
           </div>
        </nav>
     </div>
  </div>
</header>
<script>
  (function() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;

      documentElement.setAttribute("data-header-transparent", "");

      var scrollStatus = "";
      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }
      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }
    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });
    storeScrollData();
  })();
</script>
          
        

        <div class="theme-toggle">
    <input type="checkbox" id="theme-switch">
    <label for="theme-switch">
      <div class="toggle"></div>
      <div class="names">
        <p class="light">Light</p>
        <p class="dark">Dark</p>
      </div>
    </label>
  </div>
  
  
  <script>
    (function() {
      var sw = document.getElementById('theme-switch');
      var html = document.getElementsByTagName('html')[0];
      var nightModeOption = ('auto' || 'auto').toLowerCase();
      var storage = nightModeOption === 'manual'
          ? localStorage
          : sessionStorage;
      var themeData = loadThemeData();
  
      function saveThemeData(data) {
        storage.setItem('theme', JSON.stringify(data));
      }
  
      function loadThemeData() {
        var data = storage.getItem('theme');
        try {
          data = JSON.parse(data ? data : '');
        } catch(e) {
          data = { nightShift: undefined, autoToggleAt: 0 };
          saveThemeData(data);
        }
        return data;
      }
  
      function handleThemeToggle(nightShift) {
        themeData.nightShift = nightShift;
        saveThemeData(themeData);
        html.dataset.theme = nightShift ? 'dark' : 'light';
        setTimeout(function() {
          sw.checked = nightShift ? true : false;
        }, 50);
      }
  
      function autoThemeToggle() {
        // Next time point of theme toggle
        var now = new Date();
        var toggleAt = new Date();
        var hours = now.getHours();
        var nightShift = hours >= 19 || hours <=7;
  
        if (nightShift) {
          if (hours > 7) {
            toggleAt.setDate(toggleAt.getDate() + 1);
          }
          toggleAt.setHours(7);
        } else {
          toggleAt.setHours(19);
        }
  
        toggleAt.setMinutes(0);
        toggleAt.setSeconds(0);
        toggleAt.setMilliseconds(0)
  
        var delay = toggleAt.getTime() - now.getTime();
  
        // auto toggle theme mode
        setTimeout(function() {
          handleThemeToggle(!nightShift);
        }, delay);
  
        return {
          nightShift: nightShift,
          toggleAt: toggleAt.getTime()
        };
      }
  
      // Listen the theme toggle event
      sw.addEventListener('change', function(event) {
        handleThemeToggle(event.target.checked);
      });
  
      if (nightModeOption == 'auto') {
        var data = autoThemeToggle();
  
        // Toggle theme by local setting
        if (data.toggleAt > themeData.autoToggleAt) {
          themeData.autoToggleAt = data.toggleAt;
          handleThemeToggle(data.nightShift);
        } else {
          handleThemeToggle(themeData.nightShift);
        }
      } else if (nightModeOption == 'manual') {
        handleThemeToggle(themeData.nightShift);
      } else {
        var nightShift = themeData.nightShift;
        if (nightShift === undefined) {
          nightShift = nightModeOption === 'on';
        }
        handleThemeToggle(nightShift);
      }
    })();
  </script>

        <div class="page-content">
            <div class="wrapper">
                <div class="framework">
                    <section class="main">
                
<h1>Árboles de expresiones en C#</h1>

<p>El tipo de dato <code>Expression</code> no es un tipo de dato convencional, no es algo que le mostrarás al usuario final de tu app en la pantalla. Más bien es un tipo de dato diseñado para ser usado por otros desarrolladores. Este tipo de dato fue introducido junto con LINQ en .NET 3.5. Seguramente tu mismo lo has usado sin darte cuenta, el lugar más común para encontrarlo es como parámetro del método de extensión <code>Where</code> de cualquier colección que implementa la interfaz <code>IQueryable</code>:</p>
<img src="https://thatcsharpguy.github.io/postimages/aprende-c-sharp/expressions/inwhere.jpg" title="Where clause" />
<p>&quot;¡Pero si eso es una expresión lambda!&quot; podrías decirme... y tendrías toda la razón, sin embargo, existe una conversión implícita entre <code>Expression&lt;TDelegate&gt;</code> y una expresión lambda, que es lo que generalmente vemos nosotros como desarrolladores.</p>
<h3>¿Y luego?</h3>
<p>Las expresiones permiten inspeccionar el código que forma determinada expresión lambda. Por ejemplo, de la imagen anterior podríamos saber que la expresión lambda recibe un parámetro llamado <code>a</code> que es del tipo entero, que se realiza una operación módulo y que se compara contra cero el resultado. Todo esto sin necesidad de decompilar el código ni nada por el estilo.</p>
<h4>Trabajando con la expresión</h4>
<p>Los tipos <code>Expression</code> fueron creados con la intención de ser usados <a href="..\func-y-action-en-c-sharp">con delegados</a>, así que para comenzar a usarlos es necesario especificar qué tipo de delegado está esperando la expresión. Por ahora nosotros vamos a crear un método que inspeccione una expresión lambda que recibe un entero como argumento y devuelve un valor booleano:</p>
<pre><code class="language-csharp">void Inspecciona(Expression&lt;Func&lt;int, bool&gt;&gt; expression)
{
    Console.WriteLine(&quot;== Examinando \&quot;&quot; + expression + &quot;\&quot; ==&quot;);
    Console.WriteLine(&quot;Expresión: &quot; + expression.NodeType);
    var binaryExpression = expression.Body as BinaryExpression;
    if(binaryExpression != null)
    {
        Console.WriteLine(&quot;La expresión es &quot; + binaryExpression.NodeType); 					
        Console.WriteLine(&quot;Sus componentes son:&quot;);
        Console.WriteLine(&quot;\tLeft: &quot; + binaryExpression.Left + 
                          &quot; (&quot; +binaryExpression.Left.NodeType  +&quot;)&quot;);
        Console.WriteLine(&quot;\tRight: &quot; + binaryExpression.Right +
                          &quot; (&quot; + binaryExpression.Right.NodeType + &quot;)&quot;);
        return;
    }
    var constantExpression = expression.Body as ConstantExpression;
    if(constantExpression != null)
    {
        Console.WriteLine(&quot;El cuerpo de la expresión es constante&quot;);
        Console.WriteLine(&quot;\tValor: &quot; + constantExpression.Value);
        return;
    }
}
</code></pre>
<p>Lo sé, en el código de arriba ocurren muchas cosas, vamos a ver las más importantes:</p>
<ul>
<li>El <code>Expression&lt;Func&lt;int, bool&gt;&gt; expression</code> en el argumento del método indica que el método recibe una expresión que envuelva a una expresión lambda con la firma <code>Func&lt;int, bool&gt;</code></li>
<li>Con la propiedad <code>NodeType</code> podemos conocer con qué tipo de expresión estamos trabajando. Esta propiedad está disponible para cualquier tipo de <code>Expression</code></li>
<li>La propiedad <code>Body</code> nos permite acceder al cuerpo de una expresión lambda. Y a su vez, <code>Body</code> es también una expresión, es por eso que primero intento convertirla en una <code>BinaryExpression</code> y luego en una <code>ConstantExpression</code>. Existe una <a href="https://msdn.microsoft.com/en-us/library/system.linq.expressions.expression(v=vs.110).aspx#Anchor_0" target="_blank">gran lista</a> de tipos de expresiones con los que puedes trabajar.</li>
<li>Ahora, después de saber si nuestra expresión es de determinado tipo, se puede acceder a las propiedades de ese tipo en específico. Por ejemplo, las expresiones binarias tienen dos propiedades <code>Left</code> y <code>Right</code> que almacenan referencias a las expresiones que la forman, mientras que una expresión constante tiene la propiedad <code>Value</code> que almacena su verdadero valor.</li>
</ul>
<h3>Árboles de expresiones</h3>
<p>En este punto es cuando surgen los árboles de expresiones, si te das cuenta, podemos ir formando un árbol a partir de una expresión lambda, para tratar de demostrar este punto, mira los siguientes ejemplos:</p>
<pre><code class="language-csharp">Inspecciona((a) =&gt; true);
// Resultado:
//== Examinando &quot;a =&gt; True&quot; ==
//Expresión: Lambda
//El cuerpo de la expresión es constante
//	Valor: True
</code></pre>
<img src="https://thatcsharpguy.github.io/postimages/aprende-c-sharp/expressions/constant.png" title="Constant expression" />
<pre><code class="language-csharp">Inspecciona((a) =&gt; a % 2 == 0);
// Resultado:
//== Examinando &quot;a =&gt; ((a % 2) == 0)&quot; ==
//Expresión: Lambda
//La expresión es Equal
//Sus componentes son:
//	Left: (a % 2) (Modulo)
//	Right: 0 (Constant)
</code></pre>
<img src="https://thatcsharpguy.github.io/postimages/aprende-c-sharp/expressions/binarysimple.png" title="Simple binary expresion" />
<pre><code class="language-csharp">Inspecciona((a) =&gt; a % 5 == 0 &amp;&amp; Math.Pow(a, 2) % 3 == 0);
// Resultado:
//== Examinando &quot;a =&gt; (((a % 5) == 0) AndAlso ((Pow(Convert(a, Double), 2) % 3) == 0))&quot; ==
//Expresión: Lambda
//La expresión es AndAlso
//Sus componentes son:
//	Left: ((a % 5) == 0) (Equal)
//	Right: ((Pow(Convert(a, Double), 2) % 3) == 0) (Equal)
</code></pre>
<img src="https://thatcsharpguy.github.io/postimages/aprende-c-sharp/expressions/binarycomplex.png" title="Complex binary expresion" />
<h2>Uso en la vida real</h2>
<p>Sí, ya sé que tal vez no vayas por la vida escribiendo métodos que inspeccionen expresiones lambda. Pero tan solo es necesario que te pongas a pensar que gracias a los árboles de expresiones existen cosas como LINQ to SQL, Entity Framework, LinqToTwitter, entre otros.</p>
<p>Lo que hacen estas librerías es tomar tu código C# en forma de expresiones, inspeccionarlo y &quot;traducirlo&quot; a SQL para hacer que tus consultas sean lo más eficientes posible aprovechando el poder de la base de datos. En el caso de LinqToTwitter sucede algo similar, solo que la &quot;traducción&quot; transforma tu código C# en una URL lista para ser consumida.</p>
<h3>tldr</h3>
<p>En cierto sentido podrías ver a una <code>Expression&lt;TDelegate&gt;</code> como un bloque de código no compilado del que podemos obtener información en tiempo de ejecución acerca de cómo está compuesto. Algo parecido a lo que se puede lograr con <a href="..\reflexion-c-sharp-es">la reflexión</a> pero con la certidumbre de que el código con el que estás trabajando, es válido.</p>
<h3>Cuidado</h3>
<p>Para finalizar el post quisiera hacer un servicio público a la comunidad que trabaja con Entity Framework o LINQ to SQL. Y es que, cuando trabajamos escribiendo código, a veces nos agrada facilitarnos la vida reusando código como en el siguiente ejemplo:</p>
<pre><code class="language-csharp">// Filtro:
private bool ClienteAprobado(ClubUser user)
{
    return user.Approved &amp;&amp; user.IsActive;
}

// Uso de filtro:
var usuariosAprobados = _context.Users.Where(ClienteAprobado);
</code></pre>
<p>El enorme error del ejemplo anterior es que no está haciendo gran uso delos mecanismos que nos ofrece EF o L2S, sino que está cargando todos los registros a memoria y realizando el filtrado sobre los objetos, lo cual puede resultar muy costoso. Esto sucede porque el método que estamos empleando como filtro no se puede convertir a una <code>Expression</code> examinable, es solo un método.</p>
<p>La solución es simple y nos permitirá seguir reusando el código. Bastará con modificar el método que usamos como filtro para que devuelva una <code>Expression</code>:</p>
<pre><code class="language-csharp">// Filtro:
private Expression&lt;Func&lt;ClubUser, bool&gt;&gt; ClienteAprobado()
{
    return (u) =&gt; u.Approved &amp;&amp; u.IsActive;
}

// Uso de filtro:
var usuariosAprobados = _context.Users.Where(ClienteAprobado());
</code></pre>
<p>Y listo, ahora si estaremos usando al máximo los beneficios de los frameworks :)</p>



                    </section>
                    <section class="sidebar">
                    <div class="post-menu">
                        <div class="post-menu-title">Sígueme en</div>
                        <div class="common-list">
                            <ul>
                            
                                <li>
                                    <a href="https://github.com/fferegrino">
                                    GitHub<span> <i class="fa fa-github"></i> </span>
                                    </a>
                                </li>
                            
                                <li>
                                    <a href="https://twitter.com/io_exception">
                                    Twitter<span> <i class="fa fa-twitter"></i> </span>
                                    </a>
                                </li>
                            
                                <li>
                                    <a href="https://twitter.com/io_exception">
                                    YouTube<span> <i class="fa fa-youtube"></i> </span>
                                    </a>
                                </li>
                            
                                <li>
                                    <a href="https://tcsg.dev/discord">
                                    Discord<span> <i class="fa fa-discord"></i> </span>
                                    </a>
                                </li>
                            
                            </ul>
                        </div>
                    </div>
                    
                    
                    </section>
                </div>
            </div>
        </div>
        <footer class="site-footer h-card">
   <data class="u-url" href="/"></data>
 
   <div class="wrapper">
     <div class="site-footer-inner">
       <div> </div>
       <div>Powered by <a title="Lockdonw in a simple, blog-aware, static site generator." href="https://github.com/lockdownblog/lockdown">Lockdown</a> &amp; <a title="Yat, yetanother theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
       <!-- <div class="footer-col rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></div> -->
     </div>
   </div>
 </footer>
</body>
</html>
