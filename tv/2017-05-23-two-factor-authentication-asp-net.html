<!DOCTYPE html>
<html lang=""  itemscope itemtype="http://schema.org/Blog">
<head>
        <!–– Made with Lockdown: https://github.com/fferegrino/lockdown ––>
<meta charset="utf-8" />
<link rel="stylesheet" href="/css/main.css" />

        
</head>

<body>  
        <header class="site-header ui">
    <div class="wrapper menu">
      <nav class="site-nav">
        <a href="#" class="menu-icon">
          <svg viewBox="0 0 18 15">
            <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
            <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
            <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
          </svg>
        </a>
        <div class="trigger">
          <a class="link page-link" href="/">Home</a>
          <a class="link page-link" href="/about">About</a>
          <a class="link page-link" href="/search">Search</a>
        </div>
      </nav>
    </div>
    <div class="wrapper title">
      <div class="pure-g">
        <div class="pure-u-1-24 title-number"><span>1</span></div>
        <div class="pure-u-11-24 content-window">
          <a class="site-title" href="/">That C# guy</a>
        </div>
        <div class="pure-u-12-24 header-menu">
          <ul>
            <li class="datascience"><a href="/tag/data-science/">Data Science!</a></li>
            <li class="youtube"><a href="https://www.youtube.com/c/thatcsharpguy">YouTube<a></li>
            <li class="csharp"><a href="/tag/aprendecsharp/">Aprende C#</a></li>
            <li class="xamarin"><a href="/tag/xamarin/">Xamarin</a></li>
          </ul>
        </div>
      </div>
  
  </header>
        <div class="page-content">
            <div class="wrapper">
                
<h1></h1>

<p>Los pasos a realizar son los siguientes:</p>
<h2 id="creacion-del-proyecto">Creación del proyecto</h2>
<ul>
<li>Crear un nuevo proyecto, debe ser ASP.NET Core Web Application (.NET Core)</li>
<li>Como template hay que seleccionar Web Application</li>
<li>Debes cambiar las opciones de autenticación a Individal User Accounts</li>
</ul>
<h2 id="habilitar-ssl">Habilitar SSL</h2>
<ul>
<li>Agregar el paquete de NuGet: Microsoft.AspNetCore.Rewrite</li>
<li>Agregar el siguiente código en el archivo Startup.cs, línea 44</li>
</ul>
<pre><code class="language-csharp">// Enforce SSL
services.Configure&lt;MvcOptions&gt;(options =&gt;
{
	options.Filters.Add(new RequireHttpsAttribute());
});
</code></pre>
<ul>
<li>Agregar el siguiente código en el archivo Startup.cs, línea 81</li>
</ul>
<pre><code class="language-csharp">// Requires using Microsoft.AspNetCore.Rewrite;
var options = new RewriteOptions()
   .AddRedirectToHttps();
</code></pre>
<ul>
<li>Habilitar SSL en las propiedades del sitio web, en la pestaña de debug.</li>
</ul>
<h2 id="almacenar-un-codigo-unico-para-cada-usuario">Almacenar un código único para cada usuario</h2>
<ul>
<li>Agregar el siguiente código en el archivo ApplicationUser.cs, línea 12</li>
</ul>
<pre><code class="language-csharp">public virtual string TfaKey { get; set; }
</code></pre>
<ul>
<li>Agregar el siguiente código en el archivo 00000000000000_CreateIdentitySchema.cs, línea 60</li>
</ul>
<pre><code class="language-csharp">TfaKey = table.Column&lt;string&gt;(maxLength: 32, nullable: true),
</code></pre>
<h2 id="preparar-la-aplicacion-para-que-soporte-sesiones">Preparar la aplicación para que soporte sesiones</h2>
<ul>
<li>Agregar paquete de NuGet: Microsoft.AspNetCore.Session</li>
<li>Agregar el siguiente código en el archivo Startup.cs, línea 60</li>
</ul>
<pre><code class="language-csharp">// Add session support
services.AddSession(options =&gt;
{
	// Set a short timeout for easy testing.
	options.IdleTimeout = TimeSpan.FromSeconds(10);
	options.CookieHttpOnly = true;
});
</code></pre>
<ul>
<li>Agregar el siguiente código en el archivo Startup.cs, línea 98</li>
</ul>
<pre><code class="language-csharp">app.UseSession();
</code></pre>
<h2 id="agregar-codigo-de-google-authenticator">Agregar código de Google Authenticator</h2>
<p>Código de <a href="http://brandonpotter.com/2014/09/07/implementing-free-two-factor-authentication-in-net-using-google-authenticator/" target="_blank">Brandon Potter</a>.</p>
<ul>
<li>Agregar nuevo proyecto (Google.Authenticator) del tipo Class Library (.NET Core)</li>
<li>Añadir clases: <a href="https://raw.githubusercontent.com/ThatCSharpGuy/DosFactores/master/Google.Authenticator/SetupCode.cs" target="_blank">SetupCode</a> y <a href="https://raw.githubusercontent.com/ThatCSharpGuy/DosFactores/master/Google.Authenticator/TwoFactorAuthentication.cs" target="_blank">TwoFactorAuthentication</a>.</li>
<li>Agregar referencia del nuevo proyecto al sitio web</li>
</ul>
<h2 id="agregar-el-proveedor-de-tokens-en-el-sitio-web">Agregar el proveedor de tokens en el sitio web</h2>
<p>Código de <a href="http://www.domstamand.com/two-factor-authentication-in-asp-net-identity-3-using-totp-authenticator/" target="_blank">Dominique St-Amand</a>.</p>
<ul>
<li>Agregar clase <a href="https://raw.githubusercontent.com/ThatCSharpGuy/DosFactores/master/DosFactores/Providers/GoogleAuthenticatorProvider.cs" target="_blank">GoogleAuthenticatorProvider</a>.</li>
<li>Agregar el siguiente código en el archivo Startup.cs, línea 57</li>
</ul>
<pre><code class="language-csharp">.AddTokenProvider(GoogleAuthenticatorProvider.ProviderName, typeof(GoogleAuthenticatorProvider))
</code></pre>
<h2 id="preparar-la-interfaz-para-el-2fa">Preparar la interfaz para el 2FA</h2>
<ul>
<li>Agregar el siguiente código en el archivo IndexViewModel.cs, línea 17</li>
</ul>
<pre><code class="language-csharp">public string TwoFactorAuthenticatorQrCode { get; set; }
</code></pre>
<ul>
<li>Agregar el siguiente código en el archivo ManageController.cs, líneas 64, 123 y 168</li>
</ul>
<pre><code class="language-csharp">TwoFactorAuthenticatorQrCode = TempData[&quot;AuthenticatorQr&quot;]?.ToString(),
</code></pre>
<pre><code class="language-csharp">// POST: /Manage/RequestTwoFactorAuthentication
[HttpPost]
[ValidateAntiForgeryToken]
public async Task&lt;IActionResult&gt; RequestTwoFactorAuthentication()
{
  var user = await GetCurrentUserAsync();
  if (user != null)
  {
	  var tfaKey = Guid.NewGuid().ToString(&quot;N&quot;);
	  user.TfaKey = tfaKey;
	  await _userManager.UpdateAsync(user);
	  var authenticator = new TwoFactorAuthenticator();
	  var code = authenticator.GenerateSetupCode(user.UserName, tfaKey, 300, 300);
	  TempData[&quot;AuthenticatorQr&quot;] = code.QrCodeSetupImageUrl;
	  _logger.LogInformation(1, &quot;User enabled two-factor authentication.&quot;);
  }
  return RedirectToAction(nameof(Index), &quot;Manage&quot;);
}
</code></pre>
<pre><code class="language-csharp">user.TfaKey = null;
await _userManager.UpdateAsync(user);
</code></pre>
<ol start="20">
<li>Reemplazar el código del <code>&lt;dd&gt;&lt;/dd&gt;</code> de la autenticación de dos factores por</li>
</ol>
<pre><code class="language-csharp">@if (Model.TwoFactorAuthenticatorQrCode != null)
{
	&lt;img src=&quot;@Model.TwoFactorAuthenticatorQrCode&quot; /&gt;
	&lt;form asp-controller=&quot;Manage&quot; asp-action=&quot;EnableTwoFactorAuthentication&quot; method=&quot;post&quot; class=&quot;form-horizontal&quot;&gt;
		&lt;button type=&quot;submit&quot; class=&quot;btn-link btn-bracketed&quot;&gt;Yes, I've scanned the code&lt;/button&gt; Disabled
	&lt;/form&gt;
}
else
{
	if (Model.TwoFactor)
	{
		&lt;form asp-controller=&quot;Manage&quot; asp-action=&quot;DisableTwoFactorAuthentication&quot; method=&quot;post&quot; class=&quot;form-horizontal&quot;&gt;
			Enabled &lt;button type=&quot;submit&quot; class=&quot;btn-link btn-bracketed&quot;&gt;Disable&lt;/button&gt;
		&lt;/form&gt;
	}
	else
	{
		&lt;form asp-controller=&quot;Manage&quot; asp-action=&quot;RequestTwoFactorAuthentication&quot; method=&quot;post&quot; class=&quot;form-horizontal&quot;&gt;
			&lt;button type=&quot;submit&quot; class=&quot;btn-link btn-bracketed&quot;&gt;Enable&lt;/button&gt; Disabled
		&lt;/form&gt;
	}
}
</code></pre>
<h2 id="listo">Listo</h2>


            </div>
          </div>
        
</body>
</html>
